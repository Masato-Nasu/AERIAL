<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AERIAL v7.2 — Hybrid Theremin</title>
<link rel="manifest" href="manifest.json?v=72"/><link rel="icon" href="icon-192.png" sizes="192x192"/>
<style>
  :root{--bg:#0e0f12;--fg:#e6e6e6;--muted:#8a8f98}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,'Noto Sans JP',sans-serif}
  main{max-width:1100px;margin:0 auto;padding:14px;display:grid;grid-template-columns:1.1fr .9fr;gap:12px}
  @media (max-width:920px){main{grid-template-columns:1fr}}
  .card{background:#12151b;border:1px solid #1f242c;border-radius:14px;padding:14px}
  h1{font-size:18px;margin:0 0 10px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input[type=range],button,select{background:#0f1320;color:#cfe7ff;border:1px solid #253043;border-radius:10px;padding:8px 10px;font-size:14px}
  .kv{display:inline-flex;gap:6px;align-items:center;background:#0f1320;border:1px solid #253043;border-radius:12px;padding:8px 10px;font-size:13px;margin:4px 4px 0 0}
  .muted{color:var(--muted);font-size:12px}
  #canvas{width:100%;height:260px;background: radial-gradient(800px 600px at 50% 60%, #1a1f29, #0b0c0f); border:1px solid #1f242c; border-radius:12px;}
  #log{font-family:ui-monospace,Menlo,monospace;font-size:12px;white-space:pre-wrap;max-height:200px;overflow:auto;background:#0f1320;border:1px solid #253043;border-radius:10px;padding:8px}
  label{font-size:12px;color:#a7b2c0;margin-right:6px}
</style>
</head><body>
<main>
  <section class="card">
    <h1>Hybrid Theremin — Theremin Lead + Ambient Bed</h1>
    <canvas id="canvas"></canvas>
    <div class="row" style="margin-top:8px">
      <button id="btnStart">▶ Start</button>
      <button id="btnStop" disabled>⏹ Stop</button>
      <button id="btnUpdate">🔄 Force Reload</button>
      <span class="muted">イヤホン推奨・音量注意</span>
    </div>

    <div class="row" style="margin-top:8px">
      <strong style="width:100%">🎚 Theremin</strong>
      <label>Pitch Range (Hz)</label><input id="pmin" type="range" min="80" max="400" value="140"/><input id="pmax" type="range" min="400" max="1600" value="880"/>
      <label>Vibrato</label><input id="vib" type="range" min="0" max="100" value="25"/>
      <label>Timbre</label><input id="timbre" type="range" min="0" max="100" value="40"/>
      <label>Chime Sens</label><input id="chimeSens" type="range" min="20" max="200" value="60"/>
      <label>Chime Vol</label><input id="chimeVol" type="range" min="0" max="100" value="70"/>
    </div>

    <div class="row" style="margin-top:8px">
      <strong style="width:100%">🌌 Ambient</strong>
      <label>Enable</label><select id="ambEnable"><option value="on" selected>On</option><option value="off">Off</option></select>
      <label>Depth</label><input id="depth" type="range" min="0" max="100" value="70"/>
      <label>Space</label><input id="space" type="range" min="0" max="100" value="65"/>
      <label>Brightness</label><input id="bright" type="range" min="0" max="100" value="45"/>
      <label>Bed Mix</label><input id="bedmix" type="range" min="0" max="100" value="55"/>
    </div>

    <div class="muted" style="margin-top:6px">テルミンはYaw/Pitch/Roll＋地上高、衝撃でチャイム。アンビエントは連続生成で途切れなし。</div>
  </section>

  <section class="card">
    <h1>Sensors</h1>
    <div class="row">
      <div class="kv">Yaw <span id="yaw">--°</span></div>
      <div class="kv">Pitch <span id="pitch">--°</span></div>
      <div class="kv">Roll <span id="roll">--°</span></div>
      <div class="kv">Altitude <span id="alt">-- m</span></div>
      <div class="kv">Impact <span id="imp">--</span></div>
      <div class="kv">Light <span id="light">-- lux</span></div>
      <div class="kv">Motion <span id="motion">--</span></div>
    </div>
    <div style="margin-top:10px"><div id="log"></div></div>
  </section>
</main>

<script>
const els = {
  canvas: document.getElementById('canvas'),
  btnStart: document.getElementById('btnStart'),
  btnStop: document.getElementById('btnStop'),
  btnUpdate: document.getElementById('btnUpdate'),
  pmin: document.getElementById('pmin'), pmax: document.getElementById('pmax'),
  vib: document.getElementById('vib'), timbre: document.getElementById('timbre'),
  chimeSens: document.getElementById('chimeSens'), chimeVol: document.getElementById('chimeVol'),
  ambEnable: document.getElementById('ambEnable'), depth: document.getElementById('depth'),
  space: document.getElementById('space'), bright: document.getElementById('bright'), bedmix: document.getElementById('bedmix'),
  yaw: document.getElementById('yaw'), pitch: document.getElementById('pitch'), roll: document.getElementById('roll'),
  alt: document.getElementById('alt'), imp: document.getElementById('imp'),
  light: document.getElementById('light'), motion: document.getElementById('motion'),
  log: document.getElementById('log'),
};
function log(s){ els.log.textContent = (new Date()).toLocaleTimeString() + '  ' + s + "\n" + els.log.textContent; }

// ---------- Audio (Theremin + Ambient Bed) ----------
let audioCtx, master, reverb, wetG, dryG;
let thereminOsc, thereminGain, vibrato, vibratoGain, filter, bellBus;
let ambPadLow, ambPadHi, ambPadNoise, ambPadBus, ambFilter, shimmerG, lfo1, lfo2;
let running=false, wakeLock=null;
let yawN=0.5, pitchN=0.5, rollN=0.5, altitudeM=null, baseAlt=null;
let lastAccMag=null, lastChimeTime=0;
let lux=200, motionAmt=0;

function setupAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  master = audioCtx.createGain(); master.gain.value = 0.9; master.connect(audioCtx.destination);

  // Global reverb
  reverb = audioCtx.createConvolver(); reverb.buffer = makeImpulseResponse(audioCtx, 5.5, 7.0, true);
  wetG = audioCtx.createGain(); wetG.gain.value = 0.35; reverb.connect(wetG).connect(master);
  dryG = audioCtx.createGain(); dryG.gain.value = 0.9; dryG.connect(master);

  // ---- Theremin voice ----
  thereminOsc = audioCtx.createOscillator(); thereminOsc.type = 'sine';
  vibrato = audioCtx.createOscillator(); vibrato.type = 'sine'; vibrato.frequency.value = 5;
  vibratoGain = audioCtx.createGain(); vibratoGain.gain.value = 0;
  vibrato.connect(vibratoGain).connect(thereminOsc.frequency);

  filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 4000; filter.Q.value = 0.7;
  thereminGain = audioCtx.createGain(); thereminGain.gain.value = 0.0;

  thereminOsc.connect(filter).connect(wetG); // wet to reverb
  filter.connect(thereminGain).connect(dryG); // dry to master
  thereminOsc.start(); vibrato.start();

  // Chime bus
  bellBus = audioCtx.createGain(); bellBus.gain.value = 0.0; bellBus.connect(wetG); bellBus.connect(dryG);

  // ---- Ambient bed (continuous) ----
  ambPadBus = audioCtx.createGain(); ambPadBus.gain.value = 0.0; // mix by slider
  ambFilter = audioCtx.createBiquadFilter(); ambFilter.type='lowpass'; ambFilter.frequency.value = 1200; ambFilter.Q.value = 0.6;
  ambPadBus.connect(ambFilter); ambFilter.connect(wetG); ambFilter.connect(dryG);

  ambPadLow = audioCtx.createOscillator(); ambPadLow.type='sine'; ambPadLow.frequency.value = pickBaseHzByHour()/2;
  const lowG = audioCtx.createGain(); lowG.gain.value = 0.16; ambPadLow.connect(lowG).connect(ambPadBus); ambPadLow.start();

  ambPadHi = audioCtx.createOscillator(); ambPadHi.type='sawtooth'; ambPadHi.frequency.value = pickBaseHzByHour();
  const hiG = audioCtx.createGain(); hiG.gain.value = 0.10; ambPadHi.connect(hiG).connect(ambPadBus); ambPadHi.start();

  // shimmer (filtered noise)
  const ns = makeNoise(audioCtx, 2.0, true);
  const noise = audioCtx.createBufferSource(); noise.buffer = ns; noise.loop = true;
  const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value = 3000;
  shimmerG = audioCtx.createGain(); shimmerG.gain.value = 0.03;
  noise.connect(hp).connect(shimmerG).connect(wetG);
  noise.start();

  // very slow LFOs for ambient
  lfo1 = audioCtx.createOscillator(); lfo1.type='sine'; lfo1.frequency.value = 0.04;
  lfo2 = audioCtx.createOscillator(); lfo2.type='sine'; lfo2.frequency.value = 0.07;
  const l1g = audioCtx.createGain(); l1g.gain.value = 30; lfo1.connect(l1g).connect(ambFilter.frequency);
  const l2g = audioCtx.createGain(); l2g.gain.value = 0.004; lfo2.connect(l2g).connect(ambPadHi.frequency);
  lfo1.start(); lfo2.start();

  // Slider wiring
  els.depth.addEventListener('input', e=>{
    const v = e.target.value/100;
    lowG.gain.setTargetAtTime(0.06 + v*0.28, audioCtx.currentTime, 0.2);
    hiG.gain.setTargetAtTime(0.03 + v*0.2, audioCtx.currentTime, 0.2);
  });
  els.space.addEventListener('input', e=>{
    const v = e.target.value/100;
    wetG.gain.setTargetAtTime(0.15 + v*0.6, audioCtx.currentTime, 0.2);
  });
  els.bright.addEventListener('input', e=>{
    const v = e.target.value/100;
    ambFilter.frequency.setTargetAtTime(400 + v*3200, audioCtx.currentTime, 0.25);
  });
  els.bedmix.addEventListener('input', e=>{
    const v = e.target.value/100;
    ambPadBus.gain.setTargetAtTime(v*0.9 * (els.ambEnable.value==='on'?1:0), audioCtx.currentTime, 0.2);
  });
  els.ambEnable.addEventListener('change', e=>{
    const v = parseInt(els.bedmix.value,10)/100;
    ambPadBus.gain.setTargetAtTime((e.target.value==='on')? v*0.9 : 0.0, audioCtx.currentTime, 0.2);
  });
}

// Helpers
function makeImpulseResponse(ctx, duration=5.0, decay=7.0, reverse=false){
  const rate = ctx.sampleRate, length = rate*duration, impulse = ctx.createBuffer(2,length,rate);
  for (let ch=0; ch<2; ch++){ const data = impulse.getChannelData(ch);
    for (let i=0;i<length;i++){ const t = reverse ? (length-i) : i; data[i]=(Math.random()*2-1)*Math.pow(1 - t/length, decay); } }
  return impulse;
}
function makeNoise(ctx, dur=2.0){
  const len=ctx.sampleRate*dur, b=ctx.createBuffer(1,len,ctx.sampleRate), d=b.getChannelData(0); let x=0;
  for(let i=0;i<len;i++){ x = 0.98*x + (Math.random()*2-1)*0.02; d[i]=x; } return b;
}
function pickBaseHzByHour(){
  const h = new Date().getHours();
  if (h>=5 && h<11) return 196; if (h>=11 && h<17) return 220; if (h>=17 && h<22) return 174.61; return 155.56;
}
function clamp01(x){ return Math.max(0, Math.min(1, x)); }

// Theremin mapping update
function updateTheremin(){
  if (!audioCtx) return;
  const pmin = parseFloat(els.pmin.value), pmax = parseFloat(els.pmax.value);
  const pitchHz = pmin + (pmax - pmin) * clamp01((pitchN*1.05 + yawN*0.12));
  thereminOsc.frequency.setTargetAtTime(pitchHz, audioCtx.currentTime, 0.02);
  const vib = parseInt(els.vib.value,10)/100;
  vibrato.frequency.setTargetAtTime(4 + yawN*6, audioCtx.currentTime, 0.2);
  vibratoGain.gain.setTargetAtTime(vib * (2 + rollN*3), audioCtx.currentTime, 0.2);
  const timbre = parseInt(els.timbre.value,10)/100;
  filter.frequency.setTargetAtTime(800 + (rollN*timbre)*4800, audioCtx.currentTime, 0.25);
  // volume from altitude
  let vol = 0.2;
  if (altitudeM!=null){
    if (baseAlt==null) baseAlt = altitudeM;
    const rel = clamp01( (altitudeM - baseAlt + 2) / 6 );
    vol = 0.05 + rel*0.9;
  }
  thereminGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.2);
}

// Chime
function triggerChime(){
  if (!audioCtx) return;
  const vol = parseInt(els.chimeVol.value,10)/100;
  const t = audioCtx.currentTime;
  const partials = [1.0, 2.0, 2.4, 3.0];
  const base = 880;
  const g = audioCtx.createGain(); g.gain.value = 0; g.connect(bellBus);
  for (const p of partials){
    const o = audioCtx.createOscillator(); o.type = 'sine'; o.frequency.value = base * p;
    o.connect(g); o.start(t); o.stop(t + 2.5);
  }
  g.gain.setValueAtTime(0.0, t);
  g.gain.linearRampToValueAtTime(0.3*vol, t+0.02);
  g.gain.exponentialRampToValueAtTime(0.0008, t+2.5);
  bellBus.gain.setTargetAtTime(vol*0.9, t, 0.01);
  setTimeout(()=>{ bellBus.gain.setTargetAtTime(0.0, audioCtx.currentTime, 0.2); }, 2400);
}

// Sensors
async function ensureMotionPermission(){
  try{
    if (typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
      await DeviceMotionEvent.requestPermission();
    }
    if (typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
      try{ await DeviceOrientationEvent.requestPermission(); }catch(e){}
    }
  }catch(e){}
  window.addEventListener('deviceorientation', ev=>{
    const alpha=(ev.alpha||0), beta=(ev.beta||0), gamma=(ev.gamma||0);
    yawN = (alpha%360)/360;
    pitchN = (beta + 180)/360;
    rollN = (gamma + 90)/180;
    els.yaw.textContent = Math.round(alpha)+'°';
    els.pitch.textContent = Math.round(beta)+'°';
    els.roll.textContent = Math.round(gamma)+'°';
    updateTheremin();
  }, {passive:true});

  window.addEventListener('devicemotion', ev=>{
    const ax=ev.accelerationIncludingGravity?.x||0, ay=ev.accelerationIncludingGravity?.y||0, az=ev.accelerationIncludingGravity?.z||0;
    const mag = Math.sqrt(ax*ax + ay*ay + az*az);
    // motion amount for ambient shimmer
    motionAmt = Math.min(1.4, mag/12);
    els.motion.textContent = motionAmt.toFixed(2);
    // impact detection
    let jerk=0; if (lastAccMag!=null) jerk = Math.abs(mag - lastAccMag); lastAccMag=mag;
    const sens = parseInt(els.chimeSens.value,10)/100; const threshold = 2.2 * sens;
    if (jerk > threshold && (performance.now() - lastChimeTime) > 700){ lastChimeTime = performance.now(); els.imp.textContent='⚡ '+jerk.toFixed(2); triggerChime(); }
    // map to shimmer
    if (shimmerG && audioCtx){ shimmerG.gain.setTargetAtTime(0.02 + Math.min(0.18, motionAmt*0.12), audioCtx.currentTime, 0.25); }
  }, {passive:true});
}

async function startAltitude(){
  if (!navigator.geolocation){ els.alt.textContent='N/A'; return; }
  navigator.geolocation.watchPosition(pos=>{
    altitudeM = (pos.coords.altitude!=null) ? pos.coords.altitude : null;
    els.alt.textContent = altitudeM==null? '—' : altitudeM.toFixed(1)+' m';
    updateTheremin();
  }, _=>{ els.alt.textContent='denied'; }, { enableHighAccuracy:true, maximumAge:1000, timeout:5000 });
}

async function startLight(){
  if ('AmbientLightSensor' in window){
    try{
      const sensor = new AmbientLightSensor();
      sensor.addEventListener('reading', ()=>{
        lux = sensor.illuminance;
        els.light.textContent = Math.round(lux)+' lux';
        if (ambFilter && audioCtx){
          const b = parseInt(els.bright.value,10)/100;
          const target = 300 + b*2200 + Math.min(1500, lux*2);
          ambFilter.frequency.setTargetAtTime(target, audioCtx.currentTime, 0.35);
        }
      }); sensor.start(); return;
    }catch(e){}
  }
  const h=new Date().getHours(); lux=(h>=7&&h<=17)?500:60; els.light.textContent=Math.round(lux)+' lux(est)';
}

// Visual
let particles=[];
function draw(){
  const c=els.canvas, ctx=c.getContext('2d');
  const dpr=Math.min(2, devicePixelRatio||1), w=c.clientWidth, h=c.clientHeight;
  if (c.width!==Math.floor(w*dpr) || c.height!==Math.floor(h*dpr)){ c.width=Math.floor(w*dpr); c.height=Math.floor(h*dpr); ctx.setTransform(dpr,0,0,dpr,0,0); }
  const hue = 210 + (yawN*60|0);
  const g=ctx.createRadialGradient(w*0.5,h*0.55,Math.min(w,h)*0.05,w*0.5,h*0.6,Math.max(w,h)*0.9);
  g.addColorStop(0,`hsla(${hue},50%,${45+rollN*20|0}%,1)`); g.addColorStop(1,'rgba(10,12,16,1)');
  ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
  const count = 100;
  if (particles.length < count){ for(let i=0;i<3;i++) particles.push({x:Math.random()*w,y:Math.random()*h,r:4+Math.random()*10}); }
  for(const p of particles){
    p.r += 0.08 + pitchN*0.6;
    if (p.r>Math.max(w,h)*0.5){ p.r = 4; p.x=Math.random()*w; p.y=Math.random()*h; }
    ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.strokeStyle = `hsla(${hue},60%,70%,${0.02 + pitchN*0.1})`;
    ctx.lineWidth = 1 + rollN*2; ctx.stroke();
  }
  requestAnimationFrame(draw);
}

// SW & WakeLock
if('serviceWorker' in navigator){
  addEventListener('load', async ()=>{
    const reg = await navigator.serviceWorker.register('./sw.js?v=72');
    els.btnUpdate.onclick = async ()=>{ const r = await navigator.serviceWorker.getRegistration(); await r?.update(); r?.waiting?.postMessage('SKIP_WAITING'); if (!r?.waiting) location.reload(); };
  });
}
async function requestWakeLock(){ try{ if('wakeLock' in navigator){ await navigator.wakeLock.request('screen'); } }catch(e){} }

// Start/Stop
els.btnStart.onclick = async ()=>{
  if (running) return;
  setupAudio();
  await ensureMotionPermission(); await startAltitude(); await startLight();
  // apply initial ambient mix
  const v = parseInt(els.bedmix.value,10)/100; ambPadBus.gain.value = (els.ambEnable.value==='on')? v*0.9 : 0.0;
  running = true; els.btnStart.disabled=true; els.btnStop.disabled=false;
  requestWakeLock(); draw(); log('Started v7.2 Hybrid Theremin');
};
els.btnStop.onclick = ()=>{
  running=false; els.btnStart.disabled=false; els.btnStop.disabled=true;
  audioCtx && audioCtx.suspend(); log('Stopped');
};
</script>
</body></html>
