<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Beep Micro Test</title>
  <style>
    body{margin:0;background:#0b0d11;color:#e6e6e6;font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;display:grid;place-items:center;min-height:100vh}
    .card{background:#12151b;border:1px solid #1f242c;border-radius:12px;padding:16px;max-width:560px}
    button{background:#0f1320;color:#cfe7ff;border:1px solid #253043;border-radius:10px;padding:10px 14px}
    .muted{color:#8a8f98;font-size:13px;margin-top:10px}
    pre{white-space:pre-wrap;background:#0f1320;border:1px solid #253043;border-radius:8px;padding:8px;color:#cfe7ff;max-height:220px;overflow:auto}
  </style>
</head>
<body>
  <div class="card">
    <h1 style="margin:0 0 8px">🔊 Beep Micro Test</h1>
    <p>「開始」→ 440Hz が0.5秒鳴り、その後に <code>Chime.mp3</code> を再生します。</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px">
      <button id="startBtn">▶ 開始</button>
      <button id="sineBtn">🎵 440Hz</button>
      <button id="chimeBtn">🔔 チャイム</button>
    </div>
    <div class="muted">ヒント：音が出ない場合は、端末のメディア音量・サイレントスイッチ・サイトの音声「許可」を確認してください。</div>
    <h3>ログ</h3>
    <pre id="log"></pre>
  </div>
<script>
let ctx=null, master=null, chime=null;

function log(msg){ 
  console.log(msg); 
  const el=document.getElementById('log'); el.textContent += msg + "\n"; 
  el.scrollTop = el.scrollHeight;
}

async function boot(){
  if(ctx) return;
  try{
    ctx = new (window.AudioContext||window.webkitAudioContext)();
    master = ctx.createGain(); master.gain.value = 0.4; master.connect(ctx.destination);
    log("AudioContext created. state="+ctx.state);
    // Preload chime
    try{
      const res = await fetch('Chime.mp3?bust='+Date.now());
      const ab = await res.arrayBuffer();
      chime = await ctx.decodeAudioData(ab);
      log("Chime decoded: duration="+chime.duration.toFixed(2)+"s");
    }catch(e){
      log("Chime load/decode failed: "+(e && e.message ? e.message : e));
    }
  }catch(e){
    log("AudioContext create failed: "+(e && e.message ? e.message : e));
    alert("AudioContextを作成できませんでした: "+e);
  }
}

async function resume(){
  await boot();
  try{
    await ctx.resume();
    log("ctx.resume() done. state="+ctx.state);
    // 1-sample tick to bind
    const s=ctx.createBufferSource();
    s.buffer = ctx.createBuffer(1,1,ctx.sampleRate);
    s.connect(ctx.destination);
    s.start(0);
  }catch(e){
    log("resume failed: "+(e && e.message ? e.message : e));
  }
}

function playSine(){
  if(!ctx){ log("no ctx"); return; }
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  g.gain.value = 0.25;
  o.type = 'sine';
  o.frequency.value = 440;
  o.connect(g).connect(master);
  o.start();
  o.stop(ctx.currentTime + 0.5);
  log("Sine 440Hz played for 0.5s");
}

function playChime(){
  if(!ctx){ log("no ctx"); return; }
  if(!chime){ log("no chime"); return; }
  const s = ctx.createBufferSource();
  s.buffer = chime;
  const g = ctx.createGain(); g.gain.value = 0.9;
  s.connect(g).connect(master);
  s.start();
  log("Chime started");
}

document.getElementById('startBtn').onclick = async ()=>{
  await resume();
  playSine();
  setTimeout(playChime, 650);
  alert("AudioContext="+(ctx?ctx.state:"noctx")+" (開始処理完了)");
};
document.getElementById('sineBtn').onclick = async ()=>{ await resume(); playSine(); };
document.getElementById('chimeBtn').onclick = async ()=>{ await resume(); playChime(); };
</script>
</body>
</html>
