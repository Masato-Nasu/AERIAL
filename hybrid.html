<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AERIAL ‚Äî Hybrid Ambient Edition</title>
  <meta name="theme-color" content="#0e0f12" />
  <link rel="manifest" href="manifest.json?v=5" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />
  <style>
    :root { --bg:#0e0f12; --fg:#e6e6e6; --muted:#8a8f98; --accent:#8fd3ff; }
    *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, sans-serif;}
    main{max-width:1100px;margin:0 auto;padding:16px;display:grid;grid-template-columns:1.2fr .8fr; gap:16px}
    @media (max-width:960px){ main{ grid-template-columns: 1fr; } }
    .panel{background:#12151b;border:1px solid #1f242c;border-radius:14px;padding:14px}
    h1{font-size:18px;margin:0 0 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    select,button,input[type=number]{background:#0f1320;color:#cfe7ff;border:1px solid #253043;padding:8px 10px;border-radius:10px;font-size:14px}
    .btn{cursor:pointer}
    .kv{display:inline-flex;gap:6px;align-items:center;background:#0f1320;border:1px solid #253043;padding:8px 10px;border-radius:12px;font-size:13px;margin:4px 4px 0 0}
    .muted{color:#8a8f98;font-size:12px}
    #log{font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; white-space:pre-wrap; max-height:180px; overflow:auto; background:#0f1320; border:1px solid #253043; padding:8px; border-radius:10px }
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  </style>
</head>
<body>
<main>
  <section class="panel">
    <h1>Hybrid Output</h1>
    <div class="row" style="margin-bottom:8px">
      <label>Mode</label>
      <select id="mode">
        <option value="internal">Internal</option>
        <option value="midi">MIDI</option>
        <option value="hybrid" selected>Hybrid</option>
      </select>
      <label>Output</label>
      <select id="midiOut"></select>
      <label>Ch</label>
      <input id="ch" type="number" min="1" max="16" value="1" style="width:64px" />
      <button class="btn" id="btnRefresh">üîå Refresh</button>
      <button class="btn" id="btnTest">‚ô™ Test</button>
      <button class="btn" id="btnStart">‚ñ∂ Start</button>
      <button class="btn" id="btnStop" disabled>‚èπ Stop</button>
    </div>
    <div class="grid2">
      <div class="panel" style="background:#0f1320">
        <div class="muted">Mapping</div>
        <div class="kv">Shake ‚Üí Expression (CC11)</div>
        <div class="kv">Yaw ‚Üí Pan (CC10)</div>
        <div class="kv">Light ‚Üí Filter (CC74)</div>
        <div class="kv">Noise ‚Üí Beat Velocity</div>
        <div class="kv">Geo/Time ‚Üí Key/BPM</div>
        <div class="kv">Heartbeat ‚Üí 36/48 (Kick/Click)</div>
      </div>
      <div>
        <div class="row">
          <label>BPM</label><input id="bpm" type="number" min="40" max="200" value="80" />
          <label>Root</label><input id="root" type="number" min="36" max="84" value="57" />
          <label>Scale</label>
          <select id="scale">
            <option value="major">Major</option>
            <option value="minor" selected>Minor</option>
            <option value="pent">Pentatonic</option>
          </select>
        </div>
        <div class="row" style="margin-top:8px">
          <label>Pad</label><input id="pad" type="number" min="0" max="100" value="70" /> 
          <label>Mel</label><input id="mel" type="number" min="0" max="100" value="55" />
          <label>Beat</label><input id="beat" type="number" min="0" max="100" value="40" />
        </div>
        <div class="muted" style="margin-top:6px">Mode=Internal/Hybrid „ÅßÂÜÖËîµÈü≥„ÅåÈ≥¥„Çä„Åæ„Åô„ÄÇMIDI„ÅØChromeÁ≥ªÊé®Â•®„ÄÇ</div>
      </div>
    </div>
    <div style="margin-top:10px"><div id="log"></div></div>
  </section>

  <section class="panel">
    <h1>Sensors</h1>
    <div class="row">
      <div class="kv">Noise <span id="noise">-- dB</span></div>
      <div class="kv">Light <span id="light">-- lux</span></div>
      <div class="kv">Motion <span id="motion">--</span></div>
      <div class="kv">Yaw <span id="yaw">--¬∞</span></div>
      <div class="kv">Hour <span id="hour">--:--</span></div>
      <div class="kv">Lat/Lon <span id="latlon">--</span></div>
    </div>
  </section>
</main>

<script>
// ---------- UI elements ----------
const els = {
  mode: document.getElementById('mode'),
  out: document.getElementById('midiOut'),
  ch: document.getElementById('ch'),
  btnRefresh: document.getElementById('btnRefresh'),
  btnTest: document.getElementById('btnTest'),
  btnStart: document.getElementById('btnStart'),
  btnStop: document.getElementById('btnStop'),
  bpm: document.getElementById('bpm'),
  root: document.getElementById('root'),
  scale: document.getElementById('scale'),
  pad: document.getElementById('pad'),
  mel: document.getElementById('mel'),
  beat: document.getElementById('beat'),
  noise: document.getElementById('noise'),
  light: document.getElementById('light'),
  motion: document.getElementById('motion'),
  yaw: document.getElementById('yaw'),
  hour: document.getElementById('hour'),
  latlon: document.getElementById('latlon'),
  log: document.getElementById('log'),
};

// ---------- MIDI ----------
let midiAccess=null, output=null;
async function initMIDI(){
  try {
    midiAccess = await navigator.requestMIDIAccess({ sysex:false });
    refreshOutputs(); log('MIDI ready');
  } catch(e){ log('MIDI error: ' + e); }
}
function refreshOutputs(){
  els.out.innerHTML = '';
  if (!midiAccess) return;
  midiAccess.outputs.forEach((port)=>{
    const opt = document.createElement('option');
    opt.value = port.id; opt.textContent = port.name;
    els.out.appendChild(opt);
  });
  if (els.out.options.length>0){ els.out.selectedIndex = 0; changeOutput(); }
}
function changeOutput(){
  const id = els.out.value;
  output = midiAccess.outputs.get(id) || null;
  log('Output: ' + (output?output.name:'none'));
}
function send(status, data1, data2){
  if (!output || els.mode.value==='internal') return;
  const ch = (parseInt(els.ch.value,10)-1) & 0x0f;
  output.send([status | ch, data1 & 0x7f, data2 & 0x7f]);
}
const sendCC=(cc,val)=>send(0xB0,cc,val);
const noteOn=(note,vel)=>send(0x90,note,vel);
const noteOff=(note)=>send(0x80,note,0);

// ---------- Synth (Internal) ----------
let audioCtx=null, master=null, reverb=null, padGain=null, melGain=null, beatGain=null, filter=null;
let micAnalyser=null;
const SCALE = { major:[0,2,4,5,7,9,11,12], minor:[0,2,3,5,7,8,10,12], pent:[0,3,5,7,10,12] };

function wantAudio(){ return els.mode.value!=='midi'; }

function setupAudio(){
  if (!wantAudio()) return;
  if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  if (master) return;
  master = audioCtx.createGain(); master.gain.value = 0.9; master.connect(audioCtx.destination);
  reverb = audioCtx.createConvolver();
  reverb.buffer = makeImpulseResponse(audioCtx, 3.0, 5.5, true);
  const rev = audioCtx.createGain(); rev.gain.value = 0.32; reverb.connect(rev); rev.connect(master);
  filter = audioCtx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value = 1200; filter.connect(reverb); filter.connect(master);
  padGain = audioCtx.createGain(); padGain.gain.value = els.pad.value/100 * 0.5; padGain.connect(filter);
  melGain = audioCtx.createGain(); melGain.gain.value = els.mel.value/100 * 0.35; melGain.connect(reverb);
  beatGain = audioCtx.createGain(); beatGain.gain.value = els.beat.value/100 * 0.45; beatGain.connect(master);

  // Pad oscillators
  const base = pickBaseHzByHour();
  [1, 5/4, 3/2, 2].forEach(r => {
    const o = audioCtx.createOscillator(); o.type='sawtooth'; o.frequency.value = base * r;
    const vib = audioCtx.createOscillator(); vib.type='sine'; vib.frequency.value = 0.15 + Math.random()*0.1;
    const vg = audioCtx.createGain(); vg.gain.value = 1.2 + Math.random()*0.8; vib.connect(vg).connect(o.frequency); vib.start();
    const g = audioCtx.createGain(); g.gain.value = 0.08; o.connect(g).connect(padGain); o.start();
  });
}

function makeImpulseResponse(ctx, duration=2.5, decay=5, reverse=false){
  const rate = ctx.sampleRate, length = rate*duration, impulse = ctx.createBuffer(2,length,rate);
  for (let ch=0; ch<2; ch++){ const data = impulse.getChannelData(ch); for (let i=0;i<length;i++){ const t = reverse ? (length-i) : i; data[i]=(Math.random()*2-1)*Math.pow(1 - t/length, decay); } }
  return impulse;
}

function trigKick(level=0.1){
  if (wantAudio() && audioCtx){
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator(); osc.type='sine';
    osc.frequency.setValueAtTime(120, t);
    osc.frequency.exponentialRampToValueAtTime(55, t+0.12);
    const g = audioCtx.createGain(); g.gain.setValueAtTime(level, t);
    g.gain.exponentialRampToValueAtTime(0.001, t+0.2);
    osc.connect(g).connect(beatGain); osc.start(t); osc.stop(t+0.25);
    // click
    const n = audioCtx.createBufferSource(); n.buffer = makeNoise(audioCtx,0.08);
    const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000;
    const ng = audioCtx.createGain(); ng.gain.value=level*0.5; n.connect(hp).connect(ng).connect(beatGain); n.start(); n.stop(t+0.1);
  }
  // MIDI
  const vel = Math.min(127, Math.floor(80 + beatIntensity*40));
  noteOn(36, vel); setTimeout(()=>noteOff(36), 80);
}

function trigClick(level=0.07){
  if (wantAudio() && audioCtx){
    const t = audioCtx.currentTime;
    const n = audioCtx.createBufferSource(); n.buffer = makeNoise(audioCtx,0.08);
    const hp = audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=6000;
    const g = audioCtx.createGain(); g.gain.value = level;
    n.connect(hp).connect(g).connect(beatGain); n.start(t); n.stop(t+0.1);
  }
  noteOn(48, Math.min(110, Math.floor(60 + beatIntensity*40))); setTimeout(()=>noteOff(48), 60);
}

function makeNoise(ctx,dur=0.2){ const len=ctx.sampleRate*dur, b=ctx.createBuffer(1,len,ctx.sampleRate), d=b.getChannelData(0); for(let i=0;i<len;i++){ d[i]=Math.random()*2-1 } return b; }

function startMelody(){
  const base = pickBaseHzByHour(), sc = SCALE[els.scale.value];
  const o = audioCtx?.createOscillator(); if (wantAudio() && o){ o.type='triangle';
    const g = audioCtx.createGain(); g.gain.value = els.mel.value/100 * 0.22;
    const lp = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = 1800;
    o.connect(lp).connect(g).connect(reverb); o.start();
    const tick = ()=>{
      const deg = Math.floor(Math.random()*sc.length);
      const f = base*2 + (sc[deg])* (2**(1/12)); // slight detune
      o.frequency.linearRampToValueAtTime(f, audioCtx.currentTime+0.25);
      g.gain.cancelScheduledValues(audioCtx.currentTime);
      g.gain.setValueAtTime(0.02, audioCtx.currentTime);
      g.gain.linearRampToValueAtTime(els.mel.value/100 * (0.22 + motionAmt*0.08), audioCtx.currentTime+0.6);
      g.gain.linearRampToValueAtTime(0.05, audioCtx.currentTime+2.0);
      setTimeout(tick, 1800 + Math.random()*1200);
    };
    tick();
  }
  // Also send MIDI melody (upper octave)
  const root = parseInt(els.root.value,10)||57; const degs = SCALE[els.scale.value];
  const note = root + (degs[Math.floor(Math.random()*degs.length)]) + 12;
  const vel = Math.floor(40 + motionAmt*60);
  noteOn(note, vel); setTimeout(()=>noteOff(note), 900);
}

// ---------- Sensors ----------
let motionAmt=0, lux=50, yaw=0, beatIntensity=0.6;
async function ensureMotionPermission(){
  try { if (typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){ await DeviceMotionEvent.requestPermission(); } } catch(e){}
  window.addEventListener('devicemotion', ev=>{
    const ax=ev.accelerationIncludingGravity?.x||0, ay=ev.accelerationIncludingGravity?.y||0, az=ev.accelerationIncludingGravity?.z||0;
    motionAmt = Math.min(1, Math.sqrt(ax*ax+ay*ay+az*az)/20);
    els.motion.textContent = motionAmt.toFixed(2);
    sendCC(11, Math.floor(motionAmt*127));
    if (master) master.gain.value = 0.85 + motionAmt*0.15;
  }, {passive:true});
}
function startOrientation(){
  window.addEventListener('deviceorientation', ev=>{
    yaw = (ev.alpha||0); els.yaw.textContent = yaw.toFixed(0)+'¬∞';
    const pan = Math.floor((yaw/360)*127); sendCC(10, pan);
  }, {passive:true});
}
async function startLight(){
  els.hour.textContent = new Date().toTimeString().slice(0,5);
  if ('AmbientLightSensor' in window){
    try{
      const sensor = new AmbientLightSensor();
      sensor.addEventListener('reading', ()=>{
        lux = sensor.illuminance; els.light.textContent = lux.toFixed(0)+' lux';
        sendCC(74, Math.min(127, Math.floor(lux/10)));
        if (filter) filter.frequency.value = 800 + Math.min(2000, lux*2);
      }); sensor.start(); return;
    } catch(e){}
  }
  const h=new Date().getHours(); lux=(h>=7&&h<=17)?500:50; els.light.textContent = Math.round(lux)+' lux(est)';
}
async function startGeo(){
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    els.latlon.textContent = latitude.toFixed(3)+', '+longitude.toFixed(3);
    const keyOff = Math.floor((Math.abs(latitude)%12));
    els.root.value = Math.max(36, Math.min(84, (parseInt(els.root.value,10)||57) + keyOff - 6));
    const hour=new Date().getHours(); els.bpm.value = (hour>=7&&hour<=18)? 86 : 74;
  }, _=>{ els.latlon.textContent='denied'; });
}
// Mic analysis only (for intensity)
async function startMicAnalysis(){
  try{
    const ctx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    if (!audioCtx) audioCtx = ctx;
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mic = ctx.createMediaStreamSource(stream);
    micAnalyser = ctx.createAnalyser(); micAnalyser.fftSize = 1024; mic.connect(micAnalyser);
    const RAF=()=>{
      requestAnimationFrame(RAF);
      const arr = new Uint8Array(micAnalyser.fftSize/2); micAnalyser.getByteFrequencyData(arr);
      let sum=0; for (let i=0;i<arr.length;i++) sum += arr[i]*arr[i];
      const rms = Math.sqrt(sum/arr.length)/255;
      const db = 20*Math.log10(Math.max(rms,1e-6));
      els.noise.textContent = (db+90).toFixed(1)+' dB';
      beatIntensity = Math.max(0.2, Math.min(1.0, 0.2 + rms*1.6));
    }; RAF();
  }catch(e){ log('Mic error: '+e); }
}

// ---------- Music Engine ----------
let clockTimer=null, beatTimer=null, melTimer=null, running=false;
function pickBaseHzByHour(){
  const h = new Date().getHours();
  if (h>=5 && h<11) return 196; if (h>=11 && h<17) return 220; if (h>=17 && h<22) return 174.61; return 155.56;
}
function startClockAndBeat(){
  stopClockAndBeat();
  const bpm = parseInt(els.bpm.value,10)||80;
  const interval = 60000/bpm;
  beatTimer = setInterval(()=>{
    trigKick(0.1);
    setTimeout(()=>trigClick(0.05), interval*0.33);
  }, interval);
  melTimer = setInterval(()=>{ if (wantAudio()) startMelody(); else { // MIDI-only melody
    const root = parseInt(els.root.value,10)||57;
    const sc = SCALE[els.scale.value]; const note = root + sc[Math.floor(Math.random()*sc.length)] + 12;
    const vel = Math.floor(40 + motionAmt*60); noteOn(note, vel); setTimeout(()=>noteOff(note), 900);
  }}, 1800);
}
function stopClockAndBeat(){ if (beatTimer){clearInterval(beatTimer); beatTimer=null;} if (melTimer){clearInterval(melTimer); melTimer=null;} }

// ---------- UI Logic ----------
function log(s){ els.log.textContent = (new Date()).toLocaleTimeString() + '  ' + s + "\n" + els.log.textContent; }
els.btnRefresh.onclick = ()=> refreshOutputs();
els.out.onchange = changeOutput;
els.btnTest.onclick = ()=>{ if (!output){ log('No MIDI output'); return; } noteOn((parseInt(els.root.value,10)||57)+12, 90); setTimeout(()=>noteOff((parseInt(els.root.value,10)||57)+12), 300); };
els.mode.onchange = ()=>{ if (els.mode.value==='midi'){ log('Mode: MIDI only'); } else if (els.mode.value==='internal'){ log('Mode: Internal only'); setupAudio(); } else { log('Mode: Hybrid'); setupAudio(); } };
['pad','mel','beat'].forEach(id=>{ document.getElementById(id).addEventListener('input', (e)=>{
  if (!audioCtx) return;
  if (id==='pad') padGain && (padGain.gain.value = e.target.value/100 * 0.5);
  if (id==='mel') melGain && (melGain.gain.value = e.target.value/100 * 0.35);
  if (id==='beat') beatGain && (beatGain.gain.value = e.target.value/100 * 0.45);
});});

els.btnStart.onclick = async ()=>{
  if (els.mode.value!=='internal' && !navigator.requestMIDIAccess){ alert('„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ Web MIDI „Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome/Chromium „Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ'); return; }
  await initMIDI();
  if (els.mode.value!=='midi'){ setupAudio(); }
  await ensureMotionPermission(); startOrientation(); await startLight(); await startGeo(); await startMicAnalysis();
  startClockAndBeat();
  els.btnStart.disabled=true; els.btnStop.disabled=false; running=true; log('Started');
};
els.btnStop.onclick = ()=>{ stopClockAndBeat(); els.btnStart.disabled=false; els.btnStop.disabled=true; running=false; log('Stopped'); };
</script>
</body>
</html>
