<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AERIAL — Ambient Weather Music (No Mimic)</title>
  <meta name="theme-color" content="#0e0f12" />
  <link rel="manifest" href="manifest.json?v=5" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />
  <style>
    :root { --bg:#0e0f12; --fg:#e6e6e6; --muted:#8a8f98; --accent:#8fd3ff; --ok:#6ee7b7; --warn:#fbbf24; --err:#f87171; }
    *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, Helvetica, Arial, sans-serif;}
    .wrap{display:flex;flex-direction:column;min-height:100%}
    header{padding:14px 18px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #1c1f24}
    header .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 12px var(--accent)}
    header h1{font-size:18px;margin:0;letter-spacing:.3px}
    header .ver{margin-left:auto;font-size:12px;color:var(--muted)}
    main{flex:1;display:grid;grid-template-columns:1fr 320px;gap:16px;padding:16px}
    @media (max-width:900px){ main{ grid-template-columns:1fr; } }
    #stage{position:relative;border-radius:16px;overflow:hidden;background: radial-gradient(1200px 800px at 50% 60%, #1a1f29, #0b0c0f); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 10px 40px rgba(0,0,0,.6);}
    #canvas{width:100%;height:100%;display:block}
    .glass{position:absolute;inset:0;pointer-events:none;background: radial-gradient(600px 400px at var(--x,50%) var(--y,50%), rgba(143,211,255,0.12), transparent 60%);transition: background-position .2s ease;}
    aside{display:flex;flex-direction:column;gap:12px}
    .card{background:#12151b;border:1px solid #1f242c;border-radius:14px;padding:14px}
    .card h2{font-size:14px;letter-spacing:.4px;margin:0 0 8px;color:#b7c0cc}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button,.pill{background:#0f1320;color:#cfe7ff;border:1px solid #253043;padding:10px 12px;border-radius:12px;font-size:14px;cursor:pointer;transition:transform .05s ease, background .2s ease, border-color .2s ease;user-select:none;-webkit-tap-highlight-color: transparent;}
    button:hover{transform: translateY(-1px)} button:active{transform: translateY(1px) scale(.99)}
    .pill{display:inline-flex;align-items:center;gap:8px}
    .muted{color:var(--muted);font-size:12px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .start{font-weight:600;background:#11263a;border-color:#224561}
    .stop{background:#1b1420;border-color:#44234f;color:#ffd6ff}
    footer{padding:10px 16px;border-top:1px solid #1c1f24;font-size:12px;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="dot"></div>
    <h1>AERIAL</h1>
    <div class="ver">v5 • No Mimic Edition</div>
  </header>
  <main>
    <section id="stage">
      <canvas id="canvas"></canvas>
      <div class="glass"></div>
    </section>
    <aside>
      <div class="card">
        <h2>Controls</h2>
        <div class="row">
          <button id="btnStart" class="start">▶ Start</button>
          <button id="btnStop" class="stop" disabled>⏹ Stop</button>
          <button id="btnMute" class="pill" disabled>🔇 Mute</button>
          <button id="btnPhones" class="pill">🎧 Headphones</button>
          <button id="btnPerm" class="pill">⚙️ Sensors</button>
          <button id="btnUpdate" class="pill">🔄 Force Reload</button>
        </div>
        <div class="muted" style="margin-top:8px;">
          マイクは<b>解析のみ</b>使用し、スピーカーへは出しません（ミミック無効）。
        </div>
      </div>
      <div class="card">
        <h2>Sensors</h2>
        <div class="row">
          <span class="pill"><span class="k">Noise</span><span class="v" id="noise">--.- dB</span></span>
          <span class="pill"><span class="k">Light</span><span class="v" id="light">-- lux</span></span>
          <span class="pill"><span class="k">Motion</span><span class="v" id="motion">--.--</span></span>
          <span class="pill"><span class="k">Hour</span><span class="v" id="hour">--:--</span></span>
          <span class="pill"><span class="k">Lat/Lon</span><span class="v" id="latlon">--</span></span>
        </div>
      </div>
    </aside>
  </main>
  <footer>
    <span>© AERIAL · PWA</span><span>·</span><span id="status" class="muted">Idle</span>
  </footer>
</div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    const reg = await navigator.serviceWorker.register('./sw.js?v=5');
    navigator.serviceWorker.addEventListener('controllerchange', () => location.reload());
    document.getElementById('btnUpdate').onclick = async () => {
      const r = await navigator.serviceWorker.getRegistration();
      await r?.update();
      r?.waiting?.postMessage('SKIP_WAITING');
      if (!r?.waiting) location.reload();
    };
  });
}

const els = {
  canvas: document.getElementById('canvas'),
  glass: document.querySelector('.glass'),
  noise: document.getElementById('noise'),
  light: document.getElementById('light'),
  motion: document.getElementById('motion'),
  hour: document.getElementById('hour'),
  latlon: document.getElementById('latlon'),
  status: document.getElementById('status'),
  btnStart: document.getElementById('btnStart'),
  btnStop: document.getElementById('btnStop'),
  btnMute: document.getElementById('btnMute'),
  btnPhones: document.getElementById('btnPhones'),
  btnPerm: document.getElementById('btnPerm'),
};

let audioCtx, master, reverb, padGain, micAnalyser;
let running=false, muted=false, rafId;
let lux = NaN, motionAmt = 0;
let filter, lfo;
let beatTimer=null, melodyTimer=null;

function dbFromRMS(rms){ const ref = 1.0; const val = Math.max(rms, 1e-8); return 20 * Math.log10(val / ref); }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

const SCALE = [1, 9/8, 5/4, 4/3, 3/2, 5/3, 15/8, 2]; // major-like

async function setupAudio(){
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  master = audioCtx.createGain(); master.gain.value = 1.0; master.connect(audioCtx.destination);

  // Reverb
  reverb = audioCtx.createConvolver();
  reverb.buffer = makeImpulseResponse(audioCtx, 3.2, 5.5, true);
  const revGain = audioCtx.createGain(); revGain.gain.value = 0.30;
  reverb.connect(revGain); revGain.connect(master);

  // Ambient pad
  filter = audioCtx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value = 1000;
  padGain = audioCtx.createGain(); padGain.gain.value = 0.24;
  padGain.connect(filter); filter.connect(reverb); filter.connect(master);

  lfo = audioCtx.createOscillator(); lfo.type='sine'; lfo.frequency.value = 0.12;
  const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 180; lfo.connect(lfoGain); lfoGain.connect(filter.frequency); lfo.start();

  const base = pickBaseHzByHour();
  const detunes = [1, 5/4, 3/2, 2];
  detunes.forEach(r => {
    const o = audioCtx.createOscillator(); o.type='sawtooth'; o.frequency.value = base * r;
    const vib = audioCtx.createOscillator(); vib.type='sine'; vib.frequency.value = 0.18 + Math.random()*0.1;
    const vg = audioCtx.createGain(); vg.gain.value = 1.3 + Math.random()*0.8;
    vib.connect(vg).connect(o.frequency); vib.start();
    const g = audioCtx.createGain(); g.gain.value = 0.09;
    o.connect(g).connect(padGain); o.start();
  });

  // Mic for analysis only (NO output)
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mic = audioCtx.createMediaStreamSource(stream);
    micAnalyser = audioCtx.createAnalyser(); micAnalyser.fftSize = 1024;
    mic.connect(micAnalyser); // analysis only
  } catch(e){ console.warn('Mic error', e); }

  // Beat & Melody
  startBeat(base);
  startMelody(base);
}

function startBeat(base){
  stopBeat();
  const bpm = clamp(70 + (lux||50)/10 + motionAmt*40, 60, 110);
  const interval = (60/bpm)*1000;
  beatTimer = setInterval(()=>{
    if (Math.random() < 0.9) trigKick(0.08);
    if (Math.random() < 0.5) trigHat(0.03);
  }, interval);
}

function stopBeat(){ if (beatTimer){ clearInterval(beatTimer); beatTimer=null; } }

function trigKick(level=0.1){
  const o = audioCtx.createOscillator(); o.type='sine'; o.frequency.setValueAtTime(110, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(55, audioCtx.currentTime + 0.12);
  const g = audioCtx.createGain(); g.gain.setValueAtTime(level, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.18);
  o.connect(g).connect(master); o.start(); o.stop(audioCtx.currentTime + 0.2);
}

function trigHat(level=0.05){
  const src = audioCtx.createBufferSource();
  src.buffer = makeNoise(audioCtx, 0.08);
  const bp = audioCtx.createBiquadFilter(); bp.type='highpass'; bp.frequency.value = 6000;
  const g = audioCtx.createGain(); g.gain.setValueAtTime(level, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.08);
  src.connect(bp).connect(g).connect(reverb);
  src.start(); src.stop(audioCtx.currentTime + 0.1);
}

function startMelody(base){
  stopMelody();
  const o = audioCtx.createOscillator(); o.type='triangle';
  const g = audioCtx.createGain(); g.gain.value = 0.10;
  const filt = audioCtx.createBiquadFilter(); filt.type='lowpass'; filt.frequency.value = 1800;
  o.connect(filt).connect(g).connect(reverb);
  o.start();
  melodyTimer = setInterval(()=>{
    const degree = Math.floor(Math.random()* (SCALE.length-1));
    const freq = base * 2 * SCALE[degree];
    o.frequency.linearRampToValueAtTime(freq, audioCtx.currentTime + 0.2);
    g.gain.cancelScheduledValues(audioCtx.currentTime);
    g.gain.setValueAtTime(0.02, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0.10 + motionAmt*0.05, audioCtx.currentTime + 0.6);
    g.gain.linearRampToValueAtTime(0.04, audioCtx.currentTime + 2.0);
  }, 3000 + Math.random()*1500);
}

function stopMelody(){ if (melodyTimer){ clearInterval(melodyTimer); melodyTimer=null; } }

function makeImpulseResponse(ctx, duration=2, decay=3, reverse=false){
  const rate = ctx.sampleRate, length = rate*duration, impulse = ctx.createBuffer(2,length,rate);
  for (let ch=0; ch<2; ch++){ const data = impulse.getChannelData(ch);
    for (let i=0;i<length;i++){ const t = reverse ? (length - i) : i; data[i] = (Math.random()*2 - 1) * Math.pow(1 - t/length, decay); } }
  return impulse;
}
function makeNoise(ctx,duration=0.2){ const len=ctx.sampleRate*duration, b=ctx.createBuffer(1,len,ctx.sampleRate), d=b.getChannelData(0); for(let i=0;i<len;i++){ d[i]=Math.random()*2-1 } return b; }

function pickBaseHzByHour(){
  const h = new Date().getHours();
  els.hour.textContent = new Date().toTimeString().slice(0,5);
  if (h >= 5 && h < 11) return 196;
  if (h >= 11 && h < 17) return 220;
  if (h >= 17 && h < 22) return 174.61;
  return 155.56;
}

async function start(){
  if (running) return;
  els.status.textContent='Starting...';
  await setupAudio();
  running = true;
  els.btnStart.disabled=true; els.btnStop.disabled=false; els.btnMute.disabled=false;
  loop(); getGeo(); startLight(); await ensureMotionPermission();
}

function stop(){
  running=false; els.btnStart.disabled=false; els.btnStop.disabled=true; els.btnMute.disabled=true;
  stopBeat(); stopMelody();
  if (audioCtx) audioCtx.suspend();
  els.status.textContent='Stopped';
}

function toggleMute(){ muted=!muted; if (master) master.gain.value = muted ? 0 : 1.0; els.btnMute.textContent = muted ? '🔈 Unmute' : '🔇 Mute'; }

async function ensureMotionPermission(){
  try {
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
      const s = await DeviceMotionEvent.requestPermission();
      console.log('Motion perm', s);
    }
  } catch(e){ console.warn(e); }
  window.addEventListener('devicemotion', (ev) => {
    const ax = ev.accelerationIncludingGravity?.x || 0;
    const ay = ev.accelerationIncludingGravity?.y || 0;
    const az = ev.accelerationIncludingGravity?.z || 0;
    motionAmt = Math.min(1, Math.sqrt(ax*ax + ay*ay + az*az) / 20);
    els.motion.textContent = motionAmt.toFixed(2);
  }, { passive:true });
}

async function startLight(){
  if ('AmbientLightSensor' in window) {
    try {
      const sensor = new AmbientLightSensor();
      sensor.addEventListener('reading', () => { lux = sensor.illuminance; els.light.textContent = lux.toFixed(0) + ' lux'; });
      sensor.addEventListener('error', (e) => console.log('ALS error', e));
      sensor.start(); return;
    } catch(e){ console.log('ALS not available', e); }
  }
  const h = new Date().getHours();
  lux = (h >= 7 && h <= 17) ? 500 : 50;
  els.light.textContent = Math.round(lux) + ' lux (est)';
}

async function getGeo(){
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition((pos)=>{
    const { latitude, longitude } = pos.coords;
    els.latlon.textContent = latitude.toFixed(4)+', '+longitude.toFixed(4);
  }, (err)=>{ els.latlon.textContent = 'denied'; }, { enableHighAccuracy:false, timeout:3000, maximumAge:600000 });
}

function loop(){
  rafId = requestAnimationFrame(loop);
  const ctx = els.canvas.getContext('2d');
  resizeCanvas(els.canvas);
  let level = 0.02;
  if (micAnalyser) {
    const arr = new Uint8Array(micAnalyser.fftSize/2);
    micAnalyser.getByteFrequencyData(arr);
    let sum=0; for (let i=0;i<arr.length;i++) sum += arr[i]*arr[i];
    const rms = Math.sqrt(sum / arr.length) / 255;
    level = rms;
    const db = dbFromRMS(rms * 0.8 + 0.2);
    els.noise.textContent = (db+90).toFixed(1) + ' dB';
    const tgtCut = clamp(300 + rms*4000 + (lux/1000)*800, 200, 6000);
    if (filter) filter.frequency.linearRampToValueAtTime(tgtCut, (window.audioCtx?.currentTime||0) + 0.2);
  }
  drawBackground(ctx);
  drawParticles(ctx, level);
  document.onpointermove = (e)=>{
    const rect = els.canvas.getBoundingClientRect();
    const x = clamp((e.clientX - rect.left) / rect.width * 100, 0, 100);
    const y = clamp((e.clientY - rect.top) / rect.height * 100, 0, 100);
    document.querySelector('.glass').style.setProperty('--x', x+'%');
    document.querySelector('.glass').style.setProperty('--y', y+'%');
  };
  els.status.textContent = 'Running';
}

function drawBackground(ctx){
  const w = ctx.canvas.width, h = ctx.canvas.height;
  const g = ctx.createRadialGradient(w*0.5, h*(0.55 + motionAmt*0.05), Math.min(w,h)*0.05, w*0.5, h*0.6, Math.max(w,h)*0.9);
  const c1 = `rgba(${30+lux*0.05|0}, ${50+lux*0.04|0}, ${80+lux*0.06|0}, 1)`;
  const c2 = `rgba(10,12,16,1)`;
  g.addColorStop(0, c1); g.addColorStop(1, c2);
  ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
}

let particles = [];
function drawParticles(ctx, energy){
  const w = ctx.canvas.width, h = ctx.canvas.height;
  if (particles.length < 160) {
    for (let i=0;i<4;i++){
      particles.push({ x: Math.random()*w, y: Math.random()*h, vx: (Math.random()*2-1)*0.2, vy: (Math.random()*2-1)*0.2, a: Math.random()*2*Math.PI, r: 0.8+Math.random()*1.8 });
    }
  }
  for (let p of particles){
    p.vx += (Math.sin(p.a) * 0.002 + (Math.random()-0.5)*0.002) * (1+energy*12);
    p.vy += (Math.cos(p.a) * 0.002 + (Math.random()-0.5)*0.002) * (1+energy*12);
    p.x += p.vx; p.y += p.vy; p.a += 0.01 + energy*0.2;
    if (p.x<0) p.x=w; if (p.x>w) p.x=0; if (p.y<0) p.y=h; if (p.y>h) p.y=0;
    const alpha = 0.25 + energy*0.6;
    ctx.beginPath(); ctx.arc(p.x, p.y, p.r + energy*8, 0, Math.PI*2);
    ctx.fillStyle = `rgba(${140+lux*0.1|0}, ${200+lux*0.05|0}, ${255}, ${alpha})`;
    ctx.fill();
  }
}

function resizeCanvas(c){
  const dpr = Math.min(2, window.devicePixelRatio || 1);
  const w = c.clientWidth || innerWidth-340, h = c.clientHeight || (innerHeight - 220);
  if (c.width !== Math.floor(w*dpr) || c.height !== Math.floor(h*dpr)) {
    c.width = Math.floor(w*dpr); c.height = Math.floor(h*dpr);
    const ctx = c.getContext('2d'); ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
}

els.btnStart.onclick = () => { audioCtx && audioCtx.state==='suspended' ? audioCtx.resume() : null; start(); };
els.btnStop.onclick = stop;
els.btnMute.onclick = toggleMute;
els.btnPhones.onclick = () => alert('ヘッドフォン推奨：マイクとスピーカーの回り込みを抑え、より良い音像になります。');
els.btnPerm.onclick = async () => { await ensureMotionPermission(); startLight(); getGeo(); };
</script>
</body>
</html>
