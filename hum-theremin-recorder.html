<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AERIAL v21.7.1-nosw — No ServiceWorker</title>
<link rel="icon" href="icon-192.png" sizes="192x192"/>
<style>
  :root{--bg:#0e0f12;--fg:#e6e6e6;--muted:#8a8f98;--accent:#ff4d4d}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,'Noto Sans JP',sans-serif}
  main{max-width:980px;margin:0 auto;padding:14px}
  .card{background:#12151b;border:1px solid #1f242c;border-radius:12px;padding:12px;margin:12px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,input,label{background:#0f1320;color:#cfe7ff;border:1px solid #253043;border-radius:8px;padding:8px 10px}
  input[type="range"]{width:160px}
  .muted{color:var(--muted);font-size:13px}
  .chk{display:inline-flex;align-items:center;gap:6px;background:transparent;border:none;padding:0;margin-right:10px}
  #unlock{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);z-index:10}
  #unlock>div{background:#0f1320;border:1px solid #253043;border-radius:14px;padding:16px 18px;text-align:center}
  .rec-badge{display:inline-flex;align-items:center;gap:8px;padding:4px 8px;border-radius:10px;border:1px solid #442;background:#1a0a0a;color:#ffb3b3}
  .rec-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);animation:blink 1s infinite}
  @keyframes blink{0%,55%{opacity:1}75%{opacity:.25}100%{opacity:1}}
  .ok{color:#98f5a7} .warn{color:#ffd17a} .err{color:#ff9b9b}
</style>
</head><body>
<main>
  <section class="card">
    <h1 style="margin:0 0 8px">AERIAL v21.7.1-nosw — No-SW</h1>
    <div class="row">
      <button id="btnStart" class="btn">▶ Start</button>
      <label>Master</label><input id="master" type="range" min="0" max="100" value="80"/>
      <label>BGM Vol</label><input id="bgmVol" type="range" min="0" max="100" value="70"/>
      <button id="btnPick" class="btn">音楽を選ぶ</button>
      <button id="btnStopMusic" class="btn" disabled>音楽を止める</button>
      <input id="bgmFile" type="file" style="display:none"/>
      <button id="recStart" class="btn">🎙 Start Rec</button>
      <button id="recStop" class="btn" disabled>⏹ Stop</button>
      <span id="recBadge" class="rec-badge" style="display:none"><span class="rec-dot"></span>REC</span>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted">環境音（複数選択）:</span>
      <label class="chk"><input type="checkbox" id="env-birds"/>鳥</label>
      <label class="chk"><input type="checkbox" id="env-wind"/>風</label>
      <label class="chk"><input type="checkbox" id="env-waves"/>波</label>
      <label class="chk"><input type="checkbox" id="env-rain"/>雨</label>
      <label class="chk"><input type="checkbox" id="env-cafe"/>カフェ</label>
      <span class="muted">※ BGM再生中は自動ミュート。BGM Volは環境音にも反映。</span>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted">β角: <span id="betaVal">—</span>°, P: <span id="pVal">—</span></span>
      <span class="muted">CTX: <span id="ctxState">—</span></span>
      <span class="muted">BGM: <span id="bgmState">—</span></span>
    </div>
    <p class="muted">角度は<b>0°で最小、180°で最大、360°で最小</b>（継ぎ目なし）。</p>
  </section>
</main>

<div id="unlock"><div>
  <p style="margin:0 0 8px">音を出すには「Start」をタップしてください。</p>
  <button id="btnOverlayStart" class="btn">▶ Start</button>
</div></div>

<script>
let audioCtx=null, masterG;
let therOsc, therGain, therFilter, lfoAmp, lfoAmpG, lfoVib, lfoVibG;
let bgmEl=null, bgmSrc=null, bgmGain=null;
let envMaster=null, env={};
let recorder=null, recChunks=[], streamDest=null, recording=false;

const masterEl=document.getElementById('master');
const bgmVolEl=document.getElementById('bgmVol');
const btnPick=document.getElementById('btnPick');
const btnStopMusic=document.getElementById('btnStopMusic');
const bgmFile=document.getElementById('bgmFile');
const btnStart=document.getElementById('btnStart');
const ov=document.getElementById('unlock');
const ovStart=document.getElementById('btnOverlayStart');
const recStartBtn=document.getElementById('recStart'), recStopBtn=document.getElementById('recStop'), recBadge=document.getElementById('recBadge');

const betaVal=document.getElementById('betaVal');
const pVal=document.getElementById('pVal');
const ctxState=document.getElementById('ctxState');
const bgmState=document.getElementById('bgmState');

const envChecks={ birds:el('env-birds'), wind:el('env-wind'), waves:el('env-waves'), rain:el('env-rain'), cafe:el('env-cafe') };
function el(id){return document.getElementById(id);}

function toRad(d){return d*Math.PI/180;}
let cx=1, sx=0; // smoothed cos/sin
function updateBeta(betaDeg){ const r=toRad(betaDeg); const c=Math.cos(r), s=Math.sin(r); const a=0.9; cx=a*cx+(1-a)*c; sx=a*sx+(1-a)*s; }
function getP(){ const ang=Math.atan2(sx,cx); const deg=(ang*180/Math.PI+360)%360; return (1-Math.cos(toRad(deg)))/2; }

function setCtxState(){
  ctxState.textContent = audioCtx? audioCtx.state : '—';
}
function setBgmState(){
  const running = !!(bgmEl && !bgmEl.paused && !bgmEl.ended && bgmEl.src);
  bgmState.textContent = running? 'playing' : (bgmEl && bgmEl.src? 'paused' : 'idle');
  btnStopMusic.disabled = !running;
}

async function setup(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
  setCtxState();
  masterG = audioCtx.createGain(); masterG.gain.value=parseInt(masterEl.value,10)/100;
  const limiter=audioCtx.createDynamicsCompressor(); limiter.threshold.value=-6;limiter.knee.value=14;limiter.ratio.value=14;limiter.attack.value=0.003;limiter.release.value=0.25;
  masterG.connect(limiter); limiter.connect(audioCtx.destination);
  streamDest = audioCtx.createMediaStreamDestination(); limiter.connect(streamDest);
  try{ recorder = new MediaRecorder(streamDest.stream, {mimeType: 'audio/webm;codecs=opus'}); }catch(e){ recorder = null; }
  if(recorder){ recorder.ondataavailable = e=>{ if(e.data&&e.data.size) recChunks.push(e.data); }; recorder.onstop=()=>{ const b=new Blob(recChunks,{type:recorder.mimeType}); recChunks.length=0; downloadBlob(b,'AERIAL_v21.7.1-nosw_'+Date.now()+'.webm'); }; }

  envMaster=audioCtx.createGain(); envMaster.gain.value=0.0; envMaster.connect(masterG);

  therOsc=audioCtx.createOscillator(); therOsc.type='sine';
  therFilter=audioCtx.createBiquadFilter(); therFilter.type='lowpass'; therFilter.frequency.value=2200; therFilter.Q.value=0.8;
  therGain=audioCtx.createGain(); therGain.gain.value=0.12; // audible
  therOsc.connect(therFilter).connect(therGain).connect(masterG); therOsc.start();

  lfoAmp=audioCtx.createOscillator(); lfoAmp.type='sine'; lfoAmp.frequency.value=1.1;
  lfoAmpG=audioCtx.createGain(); lfoAmpG.gain.value=0.07; lfoAmp.connect(lfoAmpG).connect(therGain.gain); lfoAmp.start();
  lfoVib=audioCtx.createOscillator(); lfoVib.type='sine'; lfoVib.frequency.value=5.2;
  lfoVibG=audioCtx.createGain(); lfoVibG.gain.value=6; lfoVib.connect(lfoVibG).connect(therOsc.frequency); lfoVib.start();

  masterEl.oninput=()=>{ masterG.gain.value=parseInt(masterEl.value,10)/100; };

  bgmEl = new Audio(); bgmEl.loop=true; bgmEl.preload='auto'; bgmEl.crossOrigin='anonymous';
  bgmSrc = audioCtx.createMediaElementSource(bgmEl); bgmGain=audioCtx.createGain(); bgmGain.gain.value=parseInt(bgmVolEl.value,10)/100;
  bgmSrc.connect(bgmGain).connect(masterG);
  ['play','pause','ended','error','canplay'].forEach(ev=>bgmEl.addEventListener(ev,()=>{ setBgmState(); syncSharedVol(); }, {passive:true}));
  bgmVolEl.oninput=syncSharedVol;

  try{ if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){ await DeviceMotionEvent.requestPermission().catch(()=>{}); } }catch(e){}
  addEventListener('deviceorientation',e=>{ if(typeof e.beta==='number') updateBeta(e.beta); }, true);
  addEventListener('pointermove',e=>{ const ny=e.clientY/innerHeight; updateBeta(ny*180); }, {passive:true});

  requestAnimationFrame(updateTheremin);
}

function updateTheremin(){
  if(!audioCtx) return requestAnimationFrame(updateTheremin);
  const P = getP();
  betaVal.textContent = (Math.atan2(sx,cx)*180/Math.PI).toFixed(1);
  pVal.textContent = P.toFixed(3);
  const f = 220 + P * 1100;
  therOsc.frequency.setTargetAtTime(Math.max(40,Math.min(3200,f)), audioCtx.currentTime, 0.03);
  const vol = 0.08 + P * 0.30;
  therGain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime+0.05);
  therFilter.frequency.linearRampToValueAtTime(1800 + P*2600, audioCtx.currentTime+0.06);
  requestAnimationFrame(updateTheremin);
}

function syncSharedVol(){
  const v=parseInt(bgmVolEl.value,10)/100;
  if(bgmGain) bgmGain.gain.value=v;
  const active = !!(bgmEl && !bgmEl.paused && !bgmEl.ended && bgmEl.src);
  const target = active? 0.0 : (anyEnvSelected()? Math.max(0.15, v*0.45) : 0.0);
  envMaster.gain.cancelScheduledValues(audioCtx.currentTime);
  envMaster.gain.linearRampToValueAtTime(target, audioCtx.currentTime+0.05);
}
function setEnvMuted(m){ const v=parseInt(bgmVolEl.value,10)/100; const t = m?0.0:(anyEnvSelected()?Math.max(0.15,v*0.45):0.0); envMaster.gain.cancelScheduledValues(audioCtx.currentTime); envMaster.gain.linearRampToValueAtTime(t, audioCtx.currentTime+0.08); }
function anyEnvSelected(){ return Object.values(envChecks).some(cb=>cb.checked); }

function env_start(type){
  if(env[type]?.on) return;
  env[type]={on:true, stop:()=>{}};
  const panOK = typeof audioCtx.createStereoPanner === 'function';
  function add(node){ (panOK? node.connect(audioCtx.createStereoPanner()).connect(envMaster) : node.connect(envMaster)); }
  switch(type){
    case 'wind':{ const src=audioCtx.createBufferSource(); src.buffer=noiseBuf(4); src.loop=true; const lp=audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=700; const g=audioCtx.createGain(); g.gain.value=0.32; src.connect(lp).connect(g); add(g); src.start(); env[type].stop=()=>{ try{src.stop();}catch{} }; }break;
    case 'waves':{ const src=audioCtx.createBufferSource(); src.buffer=pinkBuf(4); src.loop=true; const bp=audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=180; bp.Q.value=0.6; const g=audioCtx.createGain(); g.gain.value=0.32; src.connect(bp).connect(g); add(g); src.start(); env[type].stop=()=>{ try{src.stop();}catch{} }; }break;
    case 'rain':{ const base=audioCtx.createBufferSource(); base.buffer=pinkBuf(3); base.loop=true; const hp=audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1200; const g=audioCtx.createGain(); g.gain.value=0.18; base.connect(hp).connect(g); add(g); base.start(); let alive=true; function drop(){ if(!alive) return; const src=audioCtx.createBufferSource(); src.buffer=noiseBuf(0.12); const bp=audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=2800; bp.Q.value=6; const eg=audioCtx.createGain(); eg.gain.value=0.0; src.connect(bp).connect(eg); add(eg); const t=audioCtx.currentTime; eg.gain.setValueAtTime(0.0,t); eg.gain.linearRampToValueAtTime(0.9,t+0.005); eg.gain.exponentialRampToValueAtTime(0.0001,t+0.18); src.start(t); src.stop(t+0.22); setTimeout(drop, 60+Math.random()*90); } drop(); env[type].stop=()=>{ alive=false; try{base.stop();}catch{} }; }break;
    case 'cafe':{ const voices=[]; const centers=[600,850,1100,1400]; for(const fc of centers){ const src=audioCtx.createBufferSource(); src.buffer=pinkBuf(2.5); src.loop=true; const bp=audioCtx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=fc; bp.Q.value=1.2; const am=audioCtx.createOscillator(); am.type='sine'; am.frequency.value=0.7+Math.random()*1.2; const amG=audioCtx.createGain(); amG.gain.value=0.22+Math.random()*0.18; const g=audioCtx.createGain(); g.gain.value=0.18; am.connect(amG).connect(g.gain); src.connect(bp).connect(g); add(g); src.start(); am.start(); voices.push(()=>{ try{src.stop();}catch{} try{am.stop();}catch{} }); } env[type].stop=()=>{ voices.forEach(fn=>fn()); }; }break;
    case 'birds':{ let alive=true; function chirp(){ if(!alive) return; const c=audioCtx.createOscillator(); const m=audioCtx.createOscillator(); c.type='sine'; m.type='sine'; const idx=audioCtx.createGain(); idx.gain.value=900; m.frequency.value=1200+Math.random()*800; c.frequency.value=2200+Math.random()*1800; m.connect(idx).connect(c.frequency); const eg=audioCtx.createGain(); eg.gain.value=0.0; c.connect(eg); add(eg); const t=audioCtx.currentTime; eg.gain.setValueAtTime(0.0,t); eg.gain.linearRampToValueAtTime(0.6,t+0.02); eg.gain.exponentialRampToValueAtTime(0.0001,t+0.18); c.start(t); m.start(t); c.stop(t+0.2); m.stop(t+0.2); setTimeout(chirp, 250+Math.random()*900); } chirp(); env[type].stop=()=>{ alive=false; }; }break;
  }
}
function env_stop(type){ if(!env[type]?.on) return; try{ env[type].stop(); }catch(e){} env[type].on=false; }
Object.entries(envChecks).forEach(([k,cb])=>cb.addEventListener('change',()=>{ cb.checked? env_start(k):env_stop(k); syncSharedVol(); },{passive:true}));

function noiseBuf(sec){ const b=audioCtx.createBuffer(1,Math.max(1,Math.floor(audioCtx.sampleRate*sec)),audioCtx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1; return b; }
function pinkBuf(sec){ const sr=audioCtx.sampleRate, n=Math.max(1,Math.floor(sr*sec)); const b=audioCtx.createBuffer(1,n,sr); const d=b.getChannelData(0); let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0; for(let i=0;i<n;i++){ const white=Math.random()*2-1; b0=0.99886*b0 + white*0.0555179; b1=0.99332*b1 + white*0.0750759; b2=0.96900*b2 + white*0.1538520; b3=0.86650*b3 + white*0.3104856; b4=0.55000*b4 + white*0.5329522; b5=-0.7616*b5 - white*0.0168980; d[i]=b0+b1+b2+b3+b4+b5+b6*0.5362; d[i]*=0.11; b6=white*0.115926; } return b; }

function anyEnvSelected(){ return Object.values(envChecks).some(cb=>cb.checked); }

function downloadBlob(blob,name){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); }

// ---------- Controls ----------
[btnStart, ovStart].forEach(b=>b.addEventListener('click', async ()=>{
  await setup();
  try{ await audioCtx.resume(); }catch(e){}
  const s=audioCtx.createBufferSource(); s.buffer=audioCtx.createBuffer(1,1,audioCtx.sampleRate); s.connect(audioCtx.destination); s.start();
  ov.style.display='none'; setCtxState();
}));

btnPick.onclick = async ()=>{
  const ua = navigator.userAgent||'';
  const isiOS = /iPhone|iPad|iPod/.test(ua);
  const isSaf = /Safari/.test(ua) && !/Chrome|Chromium|Android/.test(ua);
  if(isiOS && isSaf){ bgmFile.setAttribute('accept',''); } else { bgmFile.setAttribute('accept','.mp3,.m4a,.aac,.wav,.ogg,.flac,.aiff,.aif,.opus,.mka'); }
  if('showOpenFilePicker' in window){
    try{
      const [h] = await window.showOpenFilePicker({multiple:false, types:[{description:'Audio', accept:{'audio/*':['.mp3','.m4a','.aac','.wav','.ogg','.flac','.aiff','.aif','.opus','.mka']}}]});
      const file = await h.getFile(); const url=URL.createObjectURL(file);
      if(!audioCtx) await setup(); await audioCtx.resume();
      bgmEl.src=url; await bgmEl.play(); setBgmState();
      return;
    }catch(e){ /* fallback */ }
  }
  if('showPicker' in HTMLInputElement.prototype) bgmFile.showPicker(); else bgmFile.click();
};

bgmFile.onchange = async (e)=>{
  const f=e.target.files && e.target.files[0]; if(!f) return;
  if(!/\.(mp3|m4a|aac|wav|ogg|flac|aiff?|opus|mka)$/i.test(f.name)){ alert('音楽ファイルを選んでください'); e.target.value=''; return; }
  const url=URL.createObjectURL(f);
  if(!audioCtx) await setup(); await audioCtx.resume();
  bgmEl.src=url; try{ await bgmEl.play(); }catch(e){}; setBgmState();
};

btnStopMusic.onclick=()=>{ try{ bgmEl.pause(); bgmEl.currentTime=0; bgmEl.src=''; }catch(e){} setBgmState(); syncSharedVol(); };

recStartBtn.onclick=()=>{
  if(!audioCtx) return;
  try{
    if(recorder){ recorder.start(100); } else { alert('この端末はMediaRecorder未対応です'); return; }
    recording=true; recStartBtn.disabled=true; recStopBtn.disabled=false; recBadge.style.display='inline-flex';
  }catch(e){ alert('録音開始に失敗しました'); }
};
recStopBtn.onclick=()=>{
  if(!recording) return;
  recording=false; recStartBtn.disabled=false; recStopBtn.disabled=true; recBadge.style.display='none';
  try{ if(recorder && recorder.state!=='inactive') recorder.stop(); }catch(e){}
};

// pointer demo to simulate angle on PC
addEventListener('pointermove',(e)=>{ const ny=e.clientY/innerHeight; updateBeta(ny*180); },{passive:true});

</script>
</body></html>
