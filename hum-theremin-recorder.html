<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AERIAL v18 — Theremin + Recorder</title>
<link rel="manifest" href="manifest.json?v=18"/>
<link rel="icon" href="icon-192.png" sizes="192x192"/>
<style>
  :root{--bg:#0e0f12;--fg:#e6e6e6;--muted:#8a8f98}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif}
  main{max-width:980px;margin:0 auto;padding:14px}
  .card{background:#12151b;border:1px solid #1f242c;border-radius:12px;padding:12px;margin:12px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button,input,label{background:#0f1320;color:#cfe7ff;border:1px solid #253043;border-radius:8px;padding:8px 10px}
  input[type="range"]{accent-color:#8fd3ff}
  .muted{color:var(--muted);font-size:13px}
  #burst{position:fixed;inset:0;pointer-events:none;z-index:5}
  #unlock{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);z-index:10}
  #unlock > div{background:#0f1320;border:1px solid #253043;border-radius:14px;padding:16px 18px;text-align:center}
</style>
</head><body>
<main>
  <section class="card">
    <h1 style="margin:0 0 8px">AERIAL v18 — Theremin + Recorder</h1>
    <div class="row">
      <button id="btnPause">⏸ Pause</button>
      <label>Master</label><input id="master" type="range" min="0" max="100" value="70"/>
      <label>Theremin</label><input id="thgain" type="range" min="0" max="100" value="60"/>
      <label>音楽を選択</label><input id="bgmFile" type="file" accept="audio/*"/>
      <button id="recStart">🎙 Start Recording</button><button id="recStop" disabled>⏹ Stop</button><span id="recStatus" class="muted">Idle</span>
    </div>
    <p class="muted">動作：傾き→テルミン（連続ピッチ）、強く振る→チャイム。BGMはファイル選択のみ。BGM選択中はテルミン＋BGMのみを出力。録音はWAV保存。</p>
  </section>
</main>
<canvas id="burst"></canvas>
<div id="unlock"><div>
  <p style="margin:0 0 8px">タップして開始</p>
  <button id="btnUnlock">▶ Tap to Start</button>
</div></div>
<script>
/* ===== v18: clean graph (Theremin+BGM only), circular-smooth angles, file-only BGM ===== */
let audioCtx=null, masterG, limiter;
let therOsc, therGain;
let bgmEl=null, bgmSrc=null, bgmGain=null;
let chimeBuf=null, chimeGain;
let recNode, recBuffers=[], recording=false, recSampleRate=48000;

const masterEl=document.getElementById('master'), thgainEl=document.getElementById('thgain');
const bgmFile=document.getElementById('bgmFile');
const recStartBtn=document.getElementById('recStart'), recStopBtn=document.getElementById('recStop'), recStatus=document.getElementById('recStatus');
const btnPause=document.getElementById('btnPause');
const overlay=document.getElementById('unlock'), btnUnlock=document.getElementById('btnUnlock');

function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

async function initRecorder(){ if(!audioCtx) return; if(audioCtx.audioWorklet && audioCtx.audioWorklet._addedMixTap) return;
  const code=`class MixTap extends AudioWorkletProcessor{process(inputs){const ch=inputs[0]?.[0];if(ch)this.port.postMessage(ch);return true;}}registerProcessor('mix-tap',MixTap);`;
  const blob=new Blob([code],{type:'application/javascript'}); const url=URL.createObjectURL(blob);
  await audioCtx.audioWorklet.addModule(url); audioCtx.audioWorklet._addedMixTap=true;
  recNode=new AudioWorkletNode(audioCtx,'mix-tap');
  const tap=audioCtx.createGain(); tap.gain.value=1.0; masterG.connect(tap).connect(recNode);
  recNode.port.onmessage=(e)=>{ if(recording) recBuffers.push(new Float32Array(e.data)); };
}
function concatFloat32(arrs){let n=0;arrs.forEach(a=>n+=a.length);const out=new Float32Array(n);let o=0;for(const a of arrs){out.set(a,o);o+=a.length;}return out;}
function f32ToPCM16(f32){const dv=new DataView(new ArrayBuffer(f32.length*2));for(let i=0;i<f32.length;i++){let s=Math.max(-1,Math.min(1,f32[i]));dv.setInt16(i*2,s<0? s*0x8000 : s*0x7FFF,true);}return dv;}
function muxWAV(pcm16,sr){const buf=new ArrayBuffer(44+pcm16.byteLength);const v=new DataView(buf);function ws(o,s){for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));}ws(0,'RIFF');v.setUint32(4,36+pcm16.byteLength,true);ws(8,'WAVE');ws(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);v.setUint32(24,sr,true);v.setUint32(28,sr*2,true);v.setUint16(32,2,true);v.setUint16(34,16,true);ws(36,'data');v.setUint32(40,pcm16.byteLength,true);return new Blob([v,pcm16],{type:'audio/wav'});}

async function setup(){
  if(audioCtx) return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
  masterG=audioCtx.createGain(); masterG.gain.value=parseInt(masterEl.value,10)/100;
  limiter=audioCtx.createDynamicsCompressor(); limiter.threshold.value=-8;limiter.knee.value=12;limiter.ratio.value=12;limiter.attack.value=0.003;limiter.release.value=0.25;
  masterG.connect(limiter).connect(audioCtx.destination);

  // Theremin
  therOsc=audioCtx.createOscillator(); therOsc.type='sine'; therGain=audioCtx.createGain(); therGain.gain.value=parseInt(thgainEl.value,10)/100*0.06; therOsc.connect(therGain).connect(masterG); therOsc.start();

  // Chime
  try{ const r=await fetch('Chime.mp3'); const ab=await r.arrayBuffer(); chimeBuf=await audioCtx.decodeAudioData(ab);}catch(e){}
  chimeGain=audioCtx.createGain(); chimeGain.gain.value=Math.pow(10,2.5/20); chimeGain.connect(masterG);

  // BGM (file only)
  bgmEl=new Audio(); bgmEl.loop=true; bgmEl.preload='auto'; bgmEl.crossOrigin='anonymous';
  bgmSrc=audioCtx.createMediaElementSource(bgmEl); bgmGain=audioCtx.createGain(); bgmGain.gain.value=0.9; bgmSrc.connect(bgmGain).connect(masterG);

  await initRecorder();
  initSensors();
}

function showUnlock(){ overlay.style.display='flex'; }
function hideUnlock(){ overlay.style.display='none'; }

/* ===== Orientation: circular smoothing (avoid 360→0 jumps) ===== */
const state={yaw:0,pitch:0,roll:0};
const ALPHA=0.12;
function lerp(a,b,t){return a+(b-a)*t;}
function smoothCircular(prevDeg, nextDeg){ // vector補間で discontinuity 解消
  const pr = prevDeg*Math.PI/180, nr = nextDeg*Math.PI/180;
  const sx = Math.cos(pr), sy = Math.sin(pr);
  const tx = Math.cos(nr), ty = Math.sin(nr);
  const bx = lerp(sx, tx, ALPHA), by = lerp(sy, ty, ALPHA);
  return (Math.atan2(by, bx)*180/Math.PI);
}
function handleOrient(e){
  const yawRaw = (typeof e.alpha==='number') ? e.alpha : 0;   // 0..360
  const pitchRaw = (typeof e.beta==='number') ? e.beta : 0;   // -180..180
  const rollRaw = (typeof e.gamma==='number') ? e.gamma : 0;  // -90..90

  state.yaw = smoothCircular(state.yaw, yawRaw);
  state.pitch = smoothCircular(state.pitch, 90+pitchRaw)-90;
  state.roll = smoothCircular(state.roll, rollRaw);

  // 周期連続な sin マップで滑らかにつなぐ
  const ny = Math.sin(state.yaw*Math.PI/180);
  const np = Math.sin(state.pitch*Math.PI/180);
  const base=220, range=880;
  const f=base + (ny*0.45 + np*0.55)*range;
  if(therOsc && audioCtx){
    therOsc.frequency.setTargetAtTime(clamp(f,40,3000),audioCtx.currentTime,0.03);
  }

  // ロール→音量（完全0は避ける）
  const volBase = 0.03;
  const volSpan = 0.09*(parseInt(thgainEl.value,10)/100);
  const vol = volBase + ((Math.sin(state.roll*Math.PI/180)+1)/2)*volSpan;
  if(therGain && audioCtx) therGain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime+0.05);
}
function handleMotion(e){
  const a=e.accelerationIncludingGravity; if(!a) return;
  const mag=Math.hypot(a.x||0,a.y||0,a.z||0);
  const now=performance.now();
  if(mag>28 && (!window._lastShake || now-window._lastShake>600)){ window._lastShake=now; playChime(); triggerBurst(); }
}
async function initSensors(){
  try{ if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){ await DeviceMotionEvent.requestPermission().catch(()=>{});} }catch(e){}
  window.addEventListener('deviceorientation',handleOrient,true);
  window.addEventListener('devicemotion',handleMotion,true);
  // Pointer fallback
  window.addEventListener('pointermove',(ev)=>{const w=innerWidth,h=innerHeight;const nx=(ev.clientX/w)*360;const ny=(ev.clientY/h)*180-90;handleOrient({alpha:nx,beta:ny,gamma:0});},{passive:true});
}

function playChime(){ if(!chimeBuf||!audioCtx) return; const s=audioCtx.createBufferSource(); s.buffer=chimeBuf; s.connect(chimeGain); s.start(); }

/* Burst visual */
const cvs=document.getElementById('burst'), g=cvs.getContext('2d'); let burstT=0;
function fit(){const r=window.devicePixelRatio||1; cvs.width=innerWidth*r; cvs.height=innerHeight*r; cvs.style.width=innerWidth+'px'; cvs.style.height=innerHeight+'px'; } addEventListener('resize',fit); fit();
function triggerBurst(){ burstT=performance.now(); }
(function loop(){ requestAnimationFrame(loop); const now=performance.now(); const r=window.devicePixelRatio||1; g.setTransform(r,0,0,r,0,0); g.clearRect(0,0,cvs.width,cvs.height); if(!burstT) return; const dt=(now-burstT)/1000; if(dt>0.9){ burstT=0; return; } const cx=innerWidth/2, cy=innerHeight*0.28; const rad=40+dt*420; const a=Math.max(0,1-dt*1.2); g.beginPath(); g.arc(cx,cy,rad,0,Math.PI*2); g.strokeStyle='rgba(143,211,255,'+a.toFixed(3)+')'; g.lineWidth=2+6*(1-a); g.stroke(); })();

/* Recorder UI */
function startRec(){ if(!audioCtx) return; recBuffers.length=0; recording=true; recSampleRate=audioCtx.sampleRate; recStartBtn.disabled=true; recStopBtn.disabled=false; recStatus.textContent='Recording'; }
function stopRec(){ recording=false; recStartBtn.disabled=false; recStopBtn.disabled=true; recStatus.textContent='Saving...'; const mono=concatFloat32(recBuffers); const pcm16=f32ToPCM16(mono); const wav=muxWAV(pcm16,recSampleRate); const a=document.createElement('a'); a.href=URL.createObjectURL(wav); a.download='AERIAL_v18_'+(new Date()).toISOString().replace(/[:.]/g,'-')+'.wav'; a.click(); recStatus.textContent='Idle'; }

/* BGM (file only) */
bgmFile.onchange=async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f); bgmEl.src=url;
  try{ await bgmEl.play(); }catch(e){}
};

/* Pause/Resume */
btnPause.onclick=async ()=>{ if(!audioCtx) return; if(audioCtx.state==='running'){ await audioCtx.suspend(); btnPause.textContent='▶ Resume'; } else { await audioCtx.resume(); btnPause.textContent='⏸ Pause'; } };

/* Boot */
(async function boot(){
  await setup();
  setTimeout(async ()=>{ if(audioCtx.state!=='running'){ overlay.style.display='flex'; } }, 300);
})();

async function unlockNow(){
  try{
    if(!audioCtx) await setup();
    try{ if(typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function'){ await DeviceMotionEvent.requestPermission().catch(()=>{});} }catch(e){}
    await audioCtx.resume();
    const s=audioCtx.createBufferSource(); s.buffer=audioCtx.createBuffer(1,1,audioCtx.sampleRate); s.connect(audioCtx.destination); s.start();
    hideUnlock();
  }catch(e){ console.warn(e); }
}
['pointerdown','touchstart','keydown'].forEach(ev=>{ window.addEventListener(ev, unlockNow, {once:false,passive:true}); });
btnUnlock.onclick = unlockNow;

/* Hooks */
recStartBtn.onclick=startRec; recStopBtn.onclick=stopRec;
masterEl.oninput=()=>{ if(masterG) masterG.gain.value=parseInt(masterEl.value,10)/100; };
thgainEl.oninput=()=>{};
</script>
</body></html>
